name: Pylint

on: [push, pull_request]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    - name: Set up Python 3.13
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
        pip install -r requirements-dev.txt
    - name: Analysing the code with pylint
      run: |
        # Get the list of changed Python files
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          # For PRs, fetch the base branch to ensure we can compare
          git fetch origin ${{ github.event.pull_request.base.ref }}:refs/remotes/origin/${{ github.event.pull_request.base.ref }}
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACM origin/${{ github.event.pull_request.base.ref }}..HEAD | grep '\.py$' || true)
        else
          # For push events, compare with the previous commit
          # Handle case where there is no previous commit (initial commit or new branch)
          if [ "${{ github.event.before }}" != "0000000000000000000000000000000000000000" ] && git rev-parse --verify ${{ github.event.before }} >/dev/null 2>&1; then
            CHANGED_FILES=$(git diff --name-only --diff-filter=ACM ${{ github.event.before }} ${{ github.sha }} | grep '\.py$' || true)
          else
            # For initial commit or when before SHA is not available, check all Python files in the commit
            CHANGED_FILES=$(git diff-tree --no-commit-id --name-only --diff-filter=ACM -r ${{ github.sha }} | grep '\.py$' || true)
          fi
        fi
        
        if [ -n "$CHANGED_FILES" ]; then
          echo "Running pylint on changed files:"
          echo "$CHANGED_FILES"
          echo "$CHANGED_FILES" | xargs pylint
        else
          echo "No Python files changed, skipping pylint"
        fi
